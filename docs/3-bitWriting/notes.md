# Bit Writing

## Process
- Primary location of the random bit files is entered.
- Location of the state/pointer file is entered.
- Simultaneous writing can be enabled.
- The amount of random bit files are entered.

- Progress lock file is generated to enable resuming of writing if the system is
interrupted.
- State/pointer file is created/read, (depending if is resume or not).
- - Contains state information as AD and key k2 as data, encrypted in AES-GCM. 
Key for AES-GCM is a password derived key k1.

- RDRand is used as keystream ks1.
- Primary AES CTR mode keystream ks2 is setup for random generation.
- Secondary CTR mode keystream ks3 is setup for encryption of the random bits.
- - Key for ks3 is encrypted in AES-GCM with k2 and a in a 
keyfile.
- AES CTR mode keystreams are keyed from Quantis (if available) and /dev/random

- Random bits are generated by ks1 XOR ks2.
- ks2 is rekeyed at an interval which won't effect performance too badly.
- Random bits are then encrypted by (ks1 XOR ks2) XOR ks3.

## AES-GCM
AES-GCM is used as an encryption method for the keyfile and pointer/state file 
as it provides confidentiality and integrity protection without too much of a 
file storage footprint.  
Integrity and confidentiality needed to protect the Pointer and Key files as 
they could both be read to gain access to the random bits, or edited to change
the output of the decrypted random bits.

### Pointer/State File
The pointer/state file is an AES-GCM ciphertext file comprised of:  
`AD = scrypt-salt||file-number||byte-offset`  
`k1 = scrypt(password, salt)`  
`ctext = AES-GCM(ptext = k2, key = k1, nonce = file-number||byte-offset, AD)`  
`pointer-file = AD || ctext`

### Keyfile
Keyfile holds each of the 128 bit AES-CTR keys which are used to encrypt the 
random bit files.  
Each of these keys is encrypted using AES-GCM as follows:  
`AES-GCM(ptext = AES-CTR key, key = k2 nonce = file-number, AD = null)`

## Simultaneous writing
Simultaneous writing is availible as an option to enable a faster system to 
distribute the keys to multiple disks. This is faster over the approach of 
copying the contents of a written disk to a second disk after generation.  
Simultaneous writing has an increase of 450ms over standard writing, whereas 
copying the files after generation results in 960ms per file.  
Therefore simultaneous writing doubles the speed of distribution of the files to
multiple disks.
